# DAgger + ä¸¤é˜¶æ®µè®­ç»ƒ - å®Œæ•´æ–¹æ¡ˆæ€»ç»“

## ðŸŽ¯ æ ¸å¿ƒåŠŸèƒ½

æ‚¨çš„è®­ç»ƒçŽ°åœ¨åŒæ—¶å…·å¤‡ä¸¤å¤§åŠŸèƒ½ï¼š

### 1. **DAgger (Dataset Aggregation) - æ•°æ®èšåˆ**
- âœ… è®­ç»ƒæ—¶ä½¿ç”¨**æ•´ä¸ªåŽ†å²æ•°æ®é›†**
- âœ… æ•°æ®ä¸æ–­ç´¯ç§¯ï¼Œé¿å…é—å¿˜
- âœ… æé«˜æ•°æ®åˆ©ç”¨çŽ‡

### 2. **ä¸¤é˜¶æ®µè®­ç»ƒ - æ¸è¿›å¼å­¦ä¹ **
- âœ… **Phase 1**: ç”¨teacher actionæ›´æ–°çŽ¯å¢ƒï¼ˆæ”¶é›†é«˜è´¨é‡æ•°æ®ï¼‰
- âœ… **Phase 2**: ç”¨student actionæ›´æ–°çŽ¯å¢ƒï¼ˆæ£€éªŒå­¦ç”Ÿæ€§èƒ½ï¼‰
- âœ… ä¸¤ä¸ªé˜¶æ®µçš„æ•°æ®éƒ½ä¿ç•™åœ¨åŽ†å²bufferä¸­

## ðŸ”„ å®Œæ•´è®­ç»ƒæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Phase 1: Teacher Exploration (è¿­ä»£ 0-499)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ¯æ¬¡è¿­ä»£:                                                   â”‚
â”‚  1. è®¡ç®— student_action å’Œ teacher_action                   â”‚
â”‚  2. ç”¨ teacher_action æ›´æ–°çŽ¯å¢ƒï¼ˆé«˜è´¨é‡äº¤äº’ï¼‰                â”‚
â”‚  3. å°†æ•°æ®èšåˆåˆ°DAgger buffer                                â”‚
â”‚  4. åœ¨æ•´ä¸ªåŽ†å²bufferä¸Šè®­ç»ƒstudent                            â”‚
â”‚                                                               â”‚
â”‚  Bufferå¢žé•¿: 0 â†’ 10k â†’ 20k â†’ ... â†’ 5M                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         â•‘ è‡ªåŠ¨åˆ‡æ¢åˆ° Phase 2 (è¿­ä»£ 500)  â•‘
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Phase 2: Student Exploration (è¿­ä»£ 500+)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ¯æ¬¡è¿­ä»£:                                                   â”‚
â”‚  1. è®¡ç®— student_action å’Œ teacher_action                   â”‚
â”‚  2. ç”¨ student_action æ›´æ–°çŽ¯å¢ƒï¼ˆæ£€éªŒå­¦ç”Ÿï¼‰                  â”‚
â”‚  3. å°†æ•°æ®èšåˆåˆ°DAgger buffer                                â”‚
â”‚  4. åœ¨æ•´ä¸ªåŽ†å²bufferä¸Šè®­ç»ƒï¼ˆåŒ…æ‹¬Phase 1æ•°æ®ï¼ï¼‰             â”‚
â”‚                                                               â”‚
â”‚  Bufferå¢žé•¿: 5M â†’ 5.01M â†’ 5.02M â†’ ... â†’ ä¸Šé™               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ðŸ“ å½“å‰é…ç½®

```python
# foundation/tasks/point_ctrl/agents/rsl_rl_ppo_cfg.py

algorithm = RslRlDistillationAlgorithmCfg(
    num_learning_epochs=4,  
    learning_rate=1e-3,
    max_grad_norm=1.0,
    gradient_length=15,
    class_name="Distillation",
    
    # ä¸¤é˜¶æ®µè®­ç»ƒ
    use_two_stage_training=True,
    phase1_iterations=500,
    
    # DAggeræ•°æ®èšåˆ
    use_dagger=True,
    max_buffer_size=1000000,  # 100ä¸‡ä¸ªtransition
)
```

## ðŸš€ å¯åŠ¨è®­ç»ƒ

```bash
python foundation/rsl_rl/train.py \
    --num_envs 100 \
    --task distillation \
    --checkpoint logs/rsl_rl/point_ctrl_direct/2025-12-01_18-51-49/best_model.pt \
    --logger wandb \
    --log_project_name Foundation \
    env.robot.spawn.usd_path="/home/frd/Foundation/USD/cf2x.usd"
```

## ðŸ“Š é¢„æœŸè¾“å‡º

### åˆå§‹åŒ–
```
[DAgger] Initialized aggregated buffer with capacity: 100000 transitions
[DAgger] Maximum buffer size: 1000000 transitions
```

### Phase 1 è®­ç»ƒ
```
################################################################################
            Learning iteration 100/1500

Training Phase: Phase 1 (teacher actions)
Phase Iteration: 100/500 (Phase 1)

[DAgger] Aggregated 10000 transitions. Total buffer size: 1010000/1000000
```

### é˜¶æ®µåˆ‡æ¢
```
================================================================================
================================================================================
  SWITCHING TO PHASE 2: Now using STUDENT actions to update environment
  Iteration: 500
================================================================================
================================================================================
```

### Phase 2 è®­ç»ƒ
```
################################################################################
            Learning iteration 600/1500

Training Phase: Phase 2 (student actions)
Phase Iteration: 600/500 (Phase 1)

[DAgger] Aggregated 10000 transitions. Total buffer size: 1000000/1000000
```

## ðŸŽ¨ å…³é”®ä¼˜åŠ¿

### DAggerä¼˜åŠ¿
| ç‰¹æ€§ | åŽŸæ–¹æ¡ˆ | DAggeræ–¹æ¡ˆ |
|------|--------|-----------|
| è®­ç»ƒæ•°æ® | åªç”¨æœ€æ–°rollout | æ•´ä¸ªåŽ†å²æ•°æ®é›† |
| æ•°æ®åˆ©ç”¨ | æ¯ä¸ªæ ·æœ¬ç”¨1æ¬¡ | æ¯ä¸ªæ ·æœ¬é‡å¤ä½¿ç”¨ |
| è®°å¿†ä¿æŒ | å®¹æ˜“é—å¿˜ | ä¸ä¼šé—å¿˜åŽ†å² |
| è®­ç»ƒç¨³å®šæ€§ | è¾ƒä½Žï¼ˆå°batchï¼‰ | è¾ƒé«˜ï¼ˆå¤§æ•°æ®é›†ï¼‰ |

### ä¸¤é˜¶æ®µè®­ç»ƒä¼˜åŠ¿
| é˜¶æ®µ | çŽ¯å¢ƒaction | æ•°æ®è´¨é‡ | ç›®çš„ |
|------|-----------|---------|------|
| Phase 1 | Teacher | é«˜ | æ”¶é›†ä¸“å®¶æ•°æ® |
| Phase 2 | Student | çœŸå®ž | æ£€éªŒå­¦ç”Ÿæ€§èƒ½ |

### ç»„åˆå¨åŠ›
âœ… Phase 1æ”¶é›†çš„é«˜è´¨é‡æ•°æ®åœ¨Phase 2ä»ç„¶è¢«ä½¿ç”¨  
âœ… Studentåœ¨Phase 2çš„æŽ¢ç´¢æ•°æ®ä¹Ÿè¢«ä¿ç•™ç”¨äºŽè®­ç»ƒ  
âœ… è®­ç»ƒè¿‡ç¨‹æ›´ç¨³å®šï¼Œæ³›åŒ–èƒ½åŠ›æ›´å¼º  

## ðŸ’¾ å†…å­˜ä½¿ç”¨

### ä¼°ç®—
- æ¯ä¸ªtransition: ~400 bytes
- 100ä¸‡ä¸ªtransition: ~400 MB
- æ€»GPUå†…å­˜: å–å†³äºŽä½ çš„GPU

### è°ƒæ•´å»ºè®®
```python
# å†…å­˜å……è¶³ (>16GB)
max_buffer_size=2000000  # 800MB

# å†…å­˜ä¸€èˆ¬ (8-16GB)  
max_buffer_size=1000000  # 400MB (é»˜è®¤)

# å†…å­˜ç´§å¼  (<8GB)
max_buffer_size=500000   # 200MB
```

## âš™ï¸ é…ç½®é€‰é¡¹

### å®Œå…¨å¯ç”¨ï¼ˆæŽ¨èï¼‰
```python
use_two_stage_training=True
phase1_iterations=500
use_dagger=True
max_buffer_size=1000000
```

### åªç”¨DAgger
```python
use_two_stage_training=False  # å…¨ç¨‹ç”¨student action
use_dagger=True
max_buffer_size=1000000
```

### åªç”¨ä¸¤é˜¶æ®µ
```python
use_two_stage_training=True
phase1_iterations=500
use_dagger=False  # åªç”¨æœ€æ–°rollout
```

### åŽŸå§‹æ¨¡å¼
```python
use_two_stage_training=False
use_dagger=False
```

## ðŸ› é—®é¢˜æŽ’æŸ¥

### å†…å­˜ä¸è¶³
**ç—‡çŠ¶**: CUDA out of memory
**è§£å†³**: å‡å°`max_buffer_size`æˆ–`num_envs`

### Bufferæ»¡äº†
**ç—‡çŠ¶**: æ—¥å¿—æ˜¾ç¤ºbuffer sizeè¾¾åˆ°max
**è¡Œä¸º**: è‡ªåŠ¨ä¸¢å¼ƒæ—§æ•°æ®ï¼Œä¿ç•™æ–°æ•°æ®ï¼ˆæ­£å¸¸ï¼‰

### è®­ç»ƒå¾ˆæ…¢
**åŽŸå› **: æ•°æ®é›†å¤§äº†è®­ç»ƒæ—¶é—´å¢žåŠ 
**ä¼˜åŒ–**: 
- å‡å°‘`num_learning_epochs`
- å¢žåŠ `num_mini_batches`
- å‡å°`max_buffer_size`

## ðŸ“š ç›¸å…³æ–‡æ¡£

- `DAGGER_IMPLEMENTATION.md` - DAggerè¯¦ç»†å®žçŽ°
- `TWO_STAGE_TRAINING_README.md` - ä¸¤é˜¶æ®µè®­ç»ƒè¯´æ˜Ž
- `QUICK_START.md` - å¿«é€Ÿå¼€å§‹æŒ‡å—

## ðŸ“ˆ ç›‘æŽ§æŒ‡æ ‡

### WandBè®°å½•
- `Distillation/training_phase`: å½“å‰é˜¶æ®µ (1æˆ–2)
- `Loss/behavior`: è¡Œä¸ºå…‹éš†æŸå¤±
- `Train/mean_reward`: å¹³å‡å¥–åŠ±

### ç»ˆç«¯è¾“å‡º
- DAgger bufferå¤§å°
- è®­ç»ƒé˜¶æ®µä¿¡æ¯
- æŸå¤±å’Œå¥–åŠ±ç»Ÿè®¡

## âœ… æ€»ç»“

çŽ°åœ¨çš„è®­ç»ƒç³»ç»ŸåŒæ—¶å…·å¤‡ï¼š
1. âœ… **DAggeræ•°æ®èšåˆ** - å­¦ä¹ æ•´ä¸ªåŽ†å²
2. âœ… **ä¸¤é˜¶æ®µè®­ç»ƒ** - æ¸è¿›å¼å­¦ä¹ ç­–ç•¥
3. âœ… **è‡ªåŠ¨åˆ‡æ¢** - æ— éœ€äººå·¥å¹²é¢„
4. âœ… **å®Œæ•´æ—¥å¿—** - è¯¦ç»†çš„è®­ç»ƒä¿¡æ¯
5. âœ… **çµæ´»é…ç½®** - å¯æ ¹æ®éœ€æ±‚è°ƒæ•´

è®­ç»ƒå‘½ä»¤æ— éœ€ä¿®æ”¹ï¼Œç›´æŽ¥è¿è¡Œå³å¯äº«å—æ‰€æœ‰åŠŸèƒ½ï¼ðŸŽ‰
